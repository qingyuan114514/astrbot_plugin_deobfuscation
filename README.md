# 🍅 小番茄解混淆 (Tomato Scramble)

一个基于 **Gilbert 2D 空间填充曲线 + 黄金比例偏移** 的图片混淆/解混淆插件，适用于 [AstrBot](https://github.com/Soulter/AstrBot) 框架。
终于可以和你的群友光明正大（存疑）的发涩图啦！:p

## ✨ 功能特性

- **图片解混淆**：将经过小番茄算法混淆的图片还原为原图
- **图片混淆**：将普通图片通过算法进行像素级混淆处理
- **自定义密钥**：支持指定浮点密钥（范围 `(0, 1.618)`），默认为 `1.0`
- **批量处理**：单条消息可附带多张图片，一次性处理
- **引用回复**：支持引用一条含图片的消息来触发处理，无需重新发送图片
- **合并转发**：可选以合并转发消息的形式返回结果（仅 OneBot v11 平台）

## 🧠 算法简介

插件核心使用 **Gilbert 2D 空间填充曲线** 生成像素遍历顺序，再结合 **黄金比例 (φ)** 计算偏移量，对像素进行置换操作，从而实现图片的混淆与还原。

- 加密时：按曲线顺序将像素偏移写入新位置
- 解密时：按曲线顺序将像素从偏移位置读回原位

由于算法是对称可逆的，使用相同密钥即可完美还原。

## 📦 安装

### 依赖

```
Pillow
aiohttp
numpy
```

### 安装方式

将本插件放置于 AstrBot 的 `data/plugins/` 目录下，重启 AstrBot 即可自动加载。

## 🚀 使用方法

### 指令列表

| 指令 | 别名 | 说明 |
|------|------|------|
| `/解析 [key]` | `/解混淆 [key]` | 解混淆图片，`key` 可选，默认 `1.0` |
| `/混淆 [key]` | `/加密 [key]` | 混淆图片，`key` 可选，默认 `1.0` |

### 使用方式

插件支持两种图片输入方式：

**方式一：直接附带图片**

发送指令时同时附带需要处理的图片：

```
/解析              ← 使用默认密钥解混淆（消息中需附带图片）
/解析 0.5          ← 使用密钥 0.5 解混淆
/混淆              ← 使用默认密钥混淆
/混淆 1.2          ← 使用密钥 1.2 混淆
```

**方式二：引用回复图片消息**

先引用（回复）一条包含图片的消息，然后发送指令即可：

```
[引用含图片的消息]
/解析              ← 自动提取被引用消息中的图片进行解混淆
```

> 💡 如果指令消息本身附带了图片，将优先处理直接附带的图片，忽略引用消息中的图片。

> ⚠️ 密钥范围为 `(0, 1.618)`，超出范围会提示错误。加密和解密需使用相同的密钥才能正确还原。

**注意：无论哪种方式，都需要图片上传时勾选了“发送原图”**

## ⚙️ 配置项

在 AstrBot 管理面板中可修改以下配置：

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `use_forward_message` | `bool` | `false` | 通过合并转发发送解析结果（仅 OneBot v11 平台有效） |
| `forward_sender_name` | `string` | `"解混淆结果"` | 合并转发消息中显示的发送者昵称 |

## 📁 项目结构

```
astrbot_plugin_deobfuscation/
├── main.py                 # 插件主入口，指令注册与消息处理
├── tomato_scramble.py      # 核心算法：Gilbert 2D 曲线 + 黄金比例像素置换
├── metadata.yaml           # 插件元数据
├── requirements.txt        # Python 依赖
├── _conf_schema.json       # 配置项定义
└── __init__.py
```

## 📄 License

MIT License
